discovery.kubernetes "kubernetes_pods" {
role = "pod"
}

discovery.relabel "kubernetes_pods" {
targets = discovery.kubernetes.kubernetes_pods.targets

rule {
source_labels = ["__meta_kubernetes_pod_label_name"]
target_label  = "job"
}

rule {
source_labels = ["__meta_kubernetes_namespace"]
target_label  = "namespace"
}

rule {
source_labels = ["__meta_kubernetes_pod_name"]
target_label  = "pod"
}

rule {
source_labels = ["__meta_kubernetes_pod_container_name"]
target_label  = "container"
}
}

local.file_match "kubernetes_pods" {
path_targets = discovery.relabel.kubernetes_pods.output
}

loki.source.file "kubernetes_pods" {
targets               = local.file_match.kubernetes_pods.targets
forward_to            = []
legacy_positions_file = "/var/log/positions.yaml"
}
